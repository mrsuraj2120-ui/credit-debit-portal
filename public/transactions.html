<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transactions - Credit/Debit Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="flex">
    <!-- Sidebar -->
    <aside class="w-64 h-screen bg-gray-900 text-white flex flex-col p-4 space-y-6 sticky top-0">
      <h2 class="text-xl font-bold mb-4 flex items-center space-x-2">
        <span>üìÑ</span><span>Transactions</span>
      </h2>
      <nav class="flex flex-col space-y-3">
        <a href="index.html" class="hover:bg-gray-700 p-2 rounded">üè† Dashboard</a>
        <a href="companies.html" class="hover:bg-gray-700 p-2 rounded">üè¢ Companies</a>
        <a href="vendors.html" class="hover:bg-gray-700 p-2 rounded">ü§ù Vendors</a>
        <a href="transactions.html" class="hover:bg-gray-700 p-2 rounded bg-gray-700">üìÑ Transactions</a>
        <a href="items.html" class="hover:bg-gray-700 p-2 rounded">üì¶ Items</a>
        <a href="users.html" class="hover:bg-gray-700 p-2 rounded">üë§ Users</a>
        <a href="reports.html" class="hover:bg-gray-700 p-2 rounded">üìà Reports</a>
        <a href="settings.html" class="hover:bg-gray-700 p-2 rounded">‚öôÔ∏è Settings</a>
      </nav>

      <div class="mt-auto bg-gray-800 p-3 rounded-lg text-sm">
        <p class="text-xs opacity-70">Role : <span id="adminRole">Loading...</span></p>
        <button onclick="logout()" class="mt-2 bg-red-600 px-3 py-1 rounded text-xs">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Transactions</h1>
        <input type="text" placeholder="Search..." class="border p-2 rounded w-60 shadow-sm">
      </div>

      <!-- Create Transaction -->
      <div class="bg-white p-6 rounded-xl shadow mb-8">
        <h2 class="text-lg font-semibold mb-4">Create Debit / Credit note</h2>

        <!-- Selects -->
        <div class="grid grid-cols-4 gap-4 mb-4">
          <select id="type" class="border p-2 rounded">
            <option>Debit</option>
            <option>Credit</option>
          </select>
          <input id="tdate" type="date" class="border p-2 rounded" />

          <!-- Company Dropdown -->
<select id="tcompany" class="border p-2 rounded opacity-60" onchange="handleCompanySelect(this.value)" disabled>
  <option value="">--Select--</option>
</select>


          <!-- Vendor Dropdown -->
          <select id="tvendor" class="border p-2 rounded" onchange="handleVendorSelect(this.value)" disabled>
            <option value="">--Select--</option>
          </select>
        </div>

        <!-- Dynamic Add Forms -->
        <div id="newCompanyForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
          <h4 class="font-semibold mb-2 text-blue-700">‚ûï Add New Company</h4>
          <div class="grid grid-cols-3 gap-3 mb-3">
            <input id="newCompanyName" placeholder="Company Name" class="border p-2 rounded col-span-2" />
            <input id="newCompanyGST" placeholder="GSTIN" class="border p-2 rounded" />
            <input id="newCompanyEmail" placeholder="Email" class="border p-2 rounded" />
            <input id="newCompanyPhone" placeholder="Phone" class="border p-2 rounded" />
            <input id="newCompanyAddress" placeholder="Address" class="border p-2 rounded col-span-3" />
          </div>
          <button id="addCompanyBtn" class="bg-green-600 text-white px-3 py-1 rounded" onclick="addNewCompany()">Add</button>
        </div>

        <div id="newVendorForm" class="hidden bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
          <h4 class="font-semibold mb-2 text-blue-700">‚ûï Add New Vendor</h4>
          <div class="grid grid-cols-3 gap-3 mb-3">
            <input id="newVendorName" placeholder="Vendor Name" class="border p-2 rounded col-span-2" />
            <input id="newVendorGST" placeholder="GSTIN" class="border p-2 rounded" />
            <input id="newVendorEmail" placeholder="Email" class="border p-2 rounded" />
            <input id="newVendorPhone" placeholder="Phone" class="border p-2 rounded" />
            <input id="newVendorAddress" placeholder="Address" class="border p-2 rounded col-span-3" />
          </div>
          <button id="addVendorBtn" class="bg-green-600 text-white px-3 py-1 rounded" onclick="addNewVendor()">Add</button>
        </div>

        <!-- Items -->
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <h4 class="font-semibold mb-2">Items</h4>
          <div id="itemsContainer" class="mb-2 pointer-events-none opacity-60"></div>
          <div class="flex items-center gap-2">
            <button id="addItemBtn" class="bg-blue-600 text-white px-3 py-1 rounded mt-2" onclick="addItemRow()" disabled>+ Add Item</button>
            <button id="removeItemBtn" class="bg-red-500 text-white px-3 py-1 rounded mt-2" onclick="removeLastItem()" disabled>- Remove Item</button>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="submitBtn" class="bg-green-600 text-white px-4 py-2 rounded" onclick="submitTransaction('Created')">Submit</button>
          <button id="draftBtn" class="bg-yellow-500 text-white px-4 py-2 rounded" onclick="submitTransaction('Draft')">Save as Draft</button>
        </div>
      </div>

      <!-- Existing Transactions -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-lg font-semibold mb-4 text-gray-800">Created debit / credit notes</h2>
        <div class="overflow-x-auto rounded-lg border border-gray-200">
          <table class="min-w-full text-sm text-left border-collapse">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-4 py-2 font-semibold text-gray-700">ID</th>
                <th class="px-4 py-2 font-semibold text-gray-700">Type</th>
                <th class="px-4 py-2 font-semibold text-gray-700">Status</th>
                <th class="px-4 py-2 font-semibold text-gray-700">Date</th>
                <th class="px-4 py-2 font-semibold text-gray-700">From</th>
                <th class="px-4 py-2 font-semibold text-gray-700">To</th>
                <th class="px-4 py-2 font-semibold text-gray-700 text-right">Total (with tax included)</th>
                <th class="px-4 py-2 font-semibold text-gray-700 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="transTable" class="divide-y divide-gray-100 bg-white"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Edit Modal (hidden until needed) -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="bg-white w-11/12 md:w-3/4 p-6 rounded-lg shadow-lg max-h-[90vh] overflow-auto">
      <h3 class="text-lg font-semibold mb-4">Edit Transaction <span id="editTxnId"></span></h3>
      <div class="grid grid-cols-4 gap-3 mb-3">
        <select id="editType" class="border p-2 rounded col-span-1">
          <option>Debit</option>
          <option>Credit</option>
        </select>
        <input id="editDate" type="date" class="border p-2 rounded col-span-1" />
        <select id="editCompany" class="border p-2 rounded col-span-1"></select>
        <select id="editVendor" class="border p-2 rounded col-span-1"></select>
      </div>

      <div id="editItemsContainer" class="mb-4"></div>
      <div class="flex gap-2 mb-4">
        <button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="editAddItem()">+ Add Item</button>
        <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="editRemoveLast()">- Remove Item</button>
      </div>

      <div class="flex gap-2">
        <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="saveEdit('Created')">Submit</button>
        <button class="bg-yellow-500 text-white px-4 py-2 rounded" onclick="saveEdit('Draft')">Save as Draft</button>
        <button class="bg-gray-300 px-4 py-2 rounded" onclick="closeEdit()">Close</button>
      </div>
    </div>
  </div>

  <!-- ==================== SCRIPTS ==================== -->
  <script src="js/api.js"></script>
  <script>
    let uniqueParticulars = [];
    let uniqueRemarks = [];

    // Helpers to enable/disable controls
    function setVendorEnabled(enabled) {
      const vend = document.getElementById('tvendor');
      vend.disabled = !enabled;
      vend.classList.toggle('opacity-60', !enabled);
      // when disabling vendor, also disable items area
      setItemsEnabled(false);
    }

    function setCompanyEnabled(enabled) {
      const comp = document.getElementById('tcompany');
      comp.disabled = !enabled;
      comp.classList.toggle('opacity-60', !enabled);
      // When disabling company, also disable vendor
      setVendorEnabled(false);
    }
    

    function setItemsEnabled(enabled) {
      const container = document.getElementById('itemsContainer');
      const addBtn = document.getElementById('addItemBtn');
      const removeBtn = document.getElementById('removeItemBtn');
      container.classList.toggle('pointer-events-none', !enabled);
      container.classList.toggle('opacity-60', !enabled);
      addBtn.disabled = !enabled;
      removeBtn.disabled = !enabled;
    }

    // ‚úÖ Load unique values from backend
    async function loadUniqueItemValues() {
      try {
        const res = await fetch('/api/items/unique');
        const data = await res.json();
        uniqueParticulars = data.Particulars || [];
        uniqueRemarks = data.Remarks || [];
      } catch (err) {
        console.error('Failed to load unique values:', err);
      }
    }

    // Create item input with autocomplete and remove button per row
    function createItemElement() {
      const wrapper = document.createElement('div');
      wrapper.className = 'grid grid-cols-5 gap-2 mb-2 items-center item-row';
      wrapper.innerHTML = `
        <input list="particularList" placeholder="Particular" class="border p-2 rounded it-particular" />
        <datalist id="particularList">
          ${uniqueParticulars.map(v => `<option value="${v}"></option>`).join('')}
        </datalist>
        <input list="remarkList" placeholder="Remarks" class="border p-2 rounded it-remarks" />
        <datalist id="remarkList">
          ${uniqueRemarks.map(v => `<option value="${v}"></option>`).join('')}
        </datalist>
        <input placeholder="Qty" type="number" class="border p-2 rounded it-qty" />
        <input placeholder="Rate" type="number" class="border p-2 rounded it-rate" />
        <input placeholder="Tax%" type="number" class="border p-2 rounded it-tax" />
        <button class="ml-2 bg-red-500 text-white px-2 py-1 rounded remove-single" title="Remove">‚úñ</button>
      `;

      function toggleSubmitEnabled() {
  const submitBtn = document.getElementById('submitBtn');
  const itemsEls = document.querySelectorAll('#itemsContainer .item-row');
  if (!itemsEls.length) {
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-60');
    return;
  }

  const allFilled = Array.from(itemsEls).every(row => {
    const vals = Array.from(row.querySelectorAll('input')).map(i => i.value.trim());
    return vals.every(v => v !== '');
  });

  submitBtn.disabled = !allFilled;
  submitBtn.classList.toggle('opacity-60', !allFilled);
}


      // attach remove logic for this row
      wrapper.querySelector('.remove-single').addEventListener('click', (e) => {
        e.preventDefault();
        const row = wrapper;
        const values = Array.from(row.querySelectorAll('input')).map(i => i.value.trim());
        const anyFilled = values.some(v => v !== '');
        if (anyFilled) return alert('Row has values. Clear fields before removing.');
        row.remove();
      });

      wrapper.querySelectorAll('input').forEach(inp => inp.addEventListener('input', toggleSubmitEnabled));
      return wrapper;
    }

    function addItemRow() {
      document.getElementById('itemsContainer').appendChild(createItemElement());
    }

    function removeLastItem() {
      const container = document.getElementById('itemsContainer');
      const rows = container.querySelectorAll('.item-row');
      if (!rows.length) return;
      const last = rows[rows.length - 1];
      const values = Array.from(last.querySelectorAll('input')).map(i => i.value.trim());
      const anyFilled = values.some(v => v !== '');
      if (anyFilled) return alert('Last row has values. Clear it first to remove.');
      last.remove();
    }

    async function loadSelects() {
      const companies = await api.get('/companies');
      const vendors = await api.get('/vendors');
      const compSel = document.getElementById('tcompany');
      const vendSel = document.getElementById('tvendor');
      compSel.innerHTML = '<option value="">--Select--</option>';
      vendSel.innerHTML = '<option value="">--Select--</option>';
      companies.forEach(c => compSel.innerHTML += `<option value="${c.Company_ID}">${c.Company_Name}</option>`);
      vendors.forEach(v => vendSel.innerHTML += `<option value="${v.Vendor_ID}">${v.Vendor_Name}</option>`);
      compSel.innerHTML += `<option value="new">‚ûï New</option>`;
      vendSel.innerHTML += `<option value="new">‚ûï New</option>`;
      window.companyMap = Object.fromEntries(companies.map(c => [c.Company_ID, c.Company_Name]));
      window.vendorMap = Object.fromEntries(vendors.map(v => [v.Vendor_ID, v.Vendor_Name]));

      // also populate edit modal selects
      const editComp = document.getElementById('editCompany');
      const editVend = document.getElementById('editVendor');
      if (editComp) {
        editComp.innerHTML = '<option value="">--Select--</option>' + companies.map(c => `<option value="${c.Company_ID}">${c.Company_Name}</option>`).join('') + '<option value="new">‚ûï New</option>';
      }
      if (editVend) {
        editVend.innerHTML = '<option value="">--Select--</option>' + vendors.map(v => `<option value="${v.Vendor_ID}">${v.Vendor_Name}</option>`).join('') + '<option value="new">‚ûï New</option>';
      }
    }

    function handleCompanySelect(v) {
      document.getElementById('newCompanyForm').classList.toggle('hidden', v !== 'new');
      if (!v) { setVendorEnabled(false); return; }
      // if existing company selected -> enable vendor
      if (v !== 'new') { setVendorEnabled(true); return; }
      // if new selected -> enable vendor only after form filled minimally (Company Name)
      const nameEl = document.getElementById('newCompanyName');
      function check() { setVendorEnabled(!!nameEl.value.trim()); }
      nameEl.addEventListener('input', check, { once: false });
      check();
    }

    function handleVendorSelect(v) {
      document.getElementById('newVendorForm').classList.toggle('hidden', v !== 'new');
      if (!v) { setItemsEnabled(false); return; }
      if (v !== 'new') { setItemsEnabled(true); return; }
      // if new vendor selected -> enable items only after vendor name filled
      const nameEl = document.getElementById('newVendorName');
      function check() { setItemsEnabled(!!nameEl.value.trim()); }
      nameEl.addEventListener('input', check, { once: false });
      check();
    }

    async function addNewCompany() {
      const Company_Name = newCompanyName.value.trim();
      const GSTIN = newCompanyGST.value.trim();
      const Email = newCompanyEmail.value.trim();
      const Phone = newCompanyPhone.value.trim();
      const Address = newCompanyAddress.value.trim();
      if (!Company_Name) return alert('Enter company name');
      const res = await api.post('/companies', { Company_Name, GSTIN, Email, Phone, Address });
      alert('‚úÖ Company added');
      await loadSelects();
      tcompany.value = res.Company_ID;
      document.getElementById('newCompanyForm').classList.add('hidden');
      setVendorEnabled(true);
    }

    async function addNewVendor() {
      const Vendor_Name = newVendorName.value.trim();
      const GSTIN = newVendorGST.value.trim();
      const Email = newVendorEmail.value.trim();
      const Phone = newVendorPhone.value.trim();
      const Address = newVendorAddress.value.trim();
      if (!Vendor_Name) return alert('Enter vendor name');
      const res = await api.post('/vendors', { Vendor_Name, GSTIN, Email, Phone, Address });
      alert('‚úÖ Vendor added');
      await loadSelects();
      tvendor.value = res.Vendor_ID;
      document.getElementById('newVendorForm').classList.add('hidden');
      setItemsEnabled(true);
    }

    async function submitTransaction(status) {
  const Type = type.value;
  const Date = tdate.value || new Date().toISOString();
  const Company_ID = tcompany.value;
  const Vendor_ID = tvendor.value;

  const itemsEls = document.querySelectorAll('#itemsContainer .item-row');
  const Items = Array.from(itemsEls).map(el => ({
    Particular: el.querySelector('.it-particular')?.value.trim() || '',
    Remarks: el.querySelector('.it-remarks')?.value.trim() || '',
    Quantity: el.querySelector('.it-qty')?.value || 0,
    Rate: el.querySelector('.it-rate')?.value || 0,
    Tax_Percentage: el.querySelector('.it-tax')?.value || 0
  }));

  // ‚úÖ If Submit clicked (Created), validate item completeness
  if (status === 'Created') {
    const anyEmptyRow = Items.some(it =>
      !it.Particular || !it.Remarks || !it.Quantity || !it.Rate || !it.Tax_Percentage
    );
    if (anyEmptyRow) {
      alert('‚ö†Ô∏è Please fill all fields in every item row before submitting.');
      return;
    }
  }

  // ‚úÖ Ensure status is exactly what was passed
  const payload = { Type, Date, Company_ID, Vendor_ID, Items, Status: status };

  await api.post('/transactions', payload);
  alert(`Transaction ${status === 'Draft' ? 'saved as draft' : 'created successfully'} ‚úÖ`);
  loadTransactions();

  // üßπ Reset form after save
  tdate.value = '';
  tcompany.value = '';
  tvendor.value = '';
  document.getElementById('itemsContainer').innerHTML = '';
  addItemRow();
  setVendorEnabled(false);
  setItemsEnabled(false);
  toggleSubmitEnabled(); // disable submit again after reset
}


    async function loadTransactions() {
      const rows = await api.get('/transactions');
      const tbody = document.getElementById('transTable');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const cName = window.companyMap?.[r.Company_ID] || r.Company_ID;
        const vName = window.vendorMap?.[r.Vendor_ID] || r.Vendor_ID;
        const total = parseFloat(r.Total_Amount || 0).toFixed(2);
        const status = r.Status || 'Created';
        const actionHtml = status === 'Draft'
          ? `<button data-id="${r.Transaction_ID}" class="edit-btn inline-block bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-xs">‚úèÔ∏è Edit</button>`
          : `<a href="/api/transactions/${r.Transaction_ID}/pdf" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs shadow">üßæ View PDF</a>`;

        tbody.innerHTML += `
          <tr class="hover:bg-gray-50">
            <td class="p-2">${r.Transaction_ID}</td>
            <td class="p-2">${r.Type}</td>
            <td class="p-2">${status}</td>
            <td class="p-2">${r.Date}</td>
            <td class="p-2">${cName}</td>
            <td class="p-2">${vName}</td>
            <td class="p-2 text-right">‚Çπ${total}</td>
            <td class="p-2 text-center">${actionHtml}</td>
          </tr>`;
      });

      // attach edit handlers
      document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => {
        const id = e.currentTarget.dataset.id;
        openEdit(id);
      }));
    }

    function logout() { fetch('/api/logout', { credentials: 'include' }); window.location.href = 'login.html'; }

    // ----------------- EDIT FLOW -----------------
async function openEdit(id) {
  document.getElementById('editModal').classList.remove('hidden');
  document.getElementById('editTxnId').innerText = id;

  // ‚úÖ Fetch transaction
  const txn = await api.get('/transactions/' + id);

  // ‚úÖ Load dropdown data before rendering items
  await loadUniqueItemValues();
  await loadSelects();

  // ‚úÖ Fill top fields
  const typeEl = document.getElementById('editType');
  const dateEl = document.getElementById('editDate');
  const compEl = document.getElementById('editCompany');
  const vendEl = document.getElementById('editVendor');

  typeEl.value = txn.Type;
  dateEl.value = txn.Date ? txn.Date.split('T')[0] : '';
  compEl.value = txn.Company_ID || '';
  vendEl.value = txn.Vendor_ID || '';

  // ‚úÖ Make Type, Company, Vendor non-editable
  typeEl.disabled = true;
  compEl.disabled = true;
  vendEl.disabled = true;
  typeEl.classList.add('bg-gray-100');
  compEl.classList.add('bg-gray-100');
  vendEl.classList.add('bg-gray-100');

  // ‚úÖ Allow backdate ‚Üí remove min restriction
  dateEl.removeAttribute('min');

  // ‚úÖ Load existing items
  const cont = document.getElementById('editItemsContainer');
  cont.innerHTML = '';

  (txn.Items || txn.items || []).forEach(it => {
    const row = document.createElement('div');
    row.className = 'grid grid-cols-5 gap-2 mb-2 items-center';
    row.innerHTML = `
      <input list="particularList" value="${it.Particular || ''}" placeholder="Particular" class="border p-2 rounded it-particular" />
      <datalist id="particularList">
        ${uniqueParticulars.map(v => `<option value="${v}"></option>`).join('')}
      </datalist>

      <input list="remarkList" value="${it.Remarks || ''}" placeholder="Remarks" class="border p-2 rounded it-remarks" />
      <datalist id="remarkList">
        ${uniqueRemarks.map(v => `<option value="${v}"></option>`).join('')}
      </datalist>

      <input value="${it.Quantity || 0}" placeholder="Qty" type="number" class="border p-2 rounded it-qty" />
      <input value="${it.Rate || 0}" placeholder="Rate" type="number" class="border p-2 rounded it-rate" />
      <input value="${it.Tax_Percentage || 0}" placeholder="Tax%" type="number" class="border p-2 rounded it-tax" />
    `;
    cont.appendChild(row);
  });
}


    function closeEdit() { document.getElementById('editModal').classList.add('hidden'); }

    function editAddItem() {
      const cont = document.getElementById('editItemsContainer');
      const row = document.createElement('div');
      row.className = 'grid grid-cols-5 gap-2 mb-2 items-center';
      row.innerHTML = `
        <input placeholder="Particular" class="border p-2 rounded it-particular" />
        <input placeholder="Remarks" class="border p-2 rounded it-remarks" />
        <input placeholder="Qty" type="number" class="border p-2 rounded it-qty" />
        <input placeholder="Rate" type="number" class="border p-2 rounded it-rate" />
        <input placeholder="Tax%" type="number" class="border p-2 rounded it-tax" />
      `;
      cont.appendChild(row);
    }

    function editRemoveLast() {
      const cont = document.getElementById('editItemsContainer');
      const rows = cont.querySelectorAll('div.grid');
      if (!rows.length) return;
      const last = rows[rows.length - 1];
      const values = Array.from(last.querySelectorAll('input')).map(i => i.value.trim());
      const anyFilled = values.some(v => v !== '');
      if (anyFilled) return alert('Last row has values. Clear it first to remove.');
      last.remove();
    }

    async function saveEdit(status) {
      const id = document.getElementById('editTxnId').innerText;
      const Type = document.getElementById('editType').value;
      const Date = document.getElementById('editDate').value;
      const Company_ID = document.getElementById('editCompany').value;
      const Vendor_ID = document.getElementById('editVendor').value;
      const itemsEls = document.querySelectorAll('#editItemsContainer .grid');
      const Items = Array.from(itemsEls).map(el => ({
        Particular: el.querySelector('.it-particular')?.value || '',
        Remarks: el.querySelector('.it-remarks')?.value || '',
        Quantity: el.querySelector('.it-qty')?.value || 0,
        Rate: el.querySelector('.it-rate')?.value || 0,
        Tax_Percentage: el.querySelector('.it-tax')?.value || 0
      }));

      await api.put(`/transactions/${id}`, { Type, Date, Company_ID, Vendor_ID, Items, Status: status });
      alert(`Transaction ${status === 'Draft' ? 'saved as draft' : 'updated'} ‚úÖ`);
      closeEdit();
      loadTransactions();
    }

    // ----------------- Init -----------------
document.addEventListener('DOMContentLoaded', async () => {
  // prevent backdates -> set min to today
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById('tdate').min = `${yyyy}-${mm}-${dd}`;
  document.getElementById('editDate').min = `${yyyy}-${mm}-${dd}`;

  // ‚úÖ Enable company dropdown only when date is selected
  document.getElementById('tdate').addEventListener('change', e => {
    const hasDate = !!e.target.value;
    setCompanyEnabled(hasDate);

    // optional: clear company/vendor/items when date cleared
    if (!hasDate) {
      document.getElementById('tcompany').value = '';
      document.getElementById('tvendor').value = '';
      setVendorEnabled(false);
      setItemsEnabled(false);
    }
  });

  await loadUniqueItemValues();
  await loadSelects();
  addItemRow();
  setVendorEnabled(false);
  setItemsEnabled(false);
  loadTransactions();

  // close modal on outside click
  document.getElementById('editModal').addEventListener('click', (e) => {
    if (e.target.id === 'editModal') closeEdit();
  });
});
</script>

  <script src="js/rolecheck.js"></script>
</body>
</html>
